{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙˆØ¶Ø¹ÛŒØª Ù‡ÙˆØ§</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'leaflet/leaflet.js' %}"></script>
</head>

<body>
    <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± -->
    <div id="sidebar">
        <div id="authSection" class="auth-links" style="margin-bottom: 20px;">
            {% if user.is_authenticated %}
                <span>Ø³Ù„Ø§Ù… {{ user.first_name }} ğŸ‘‹</span>
                <a href="{% url 'profile' %}" class="profile-btn">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</a>
                <a href="{% url 'logout' %}" class="logout-btn">Ø®Ø±ÙˆØ¬</a>
            {% else %}
                <a href="{% url 'login' %}" class="auth-btn">ÙˆØ±ÙˆØ¯</a> |
                <a href="{% url 'register' %}" class="auth-btn">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</a>
            {% endif %}
        </div>

        <h2 style="color: rgb(84, 90, 84);">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡ÙˆØ§</h2>
        <input type="text" id="cityInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: Tehran">
        <button onclick="searchCity()">Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù‡Ø±</button>

        <div id="weatherPanel" class="hidden">
            <div id="weatherInfo"></div>
            <button id="showForecastBtn" onclick="getForecast()" class="forecastbtn">Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ûµ Ø±ÙˆØ²Ù‡</button>
        </div>
    </div>

    <!-- Ù†Ù‚Ø´Ù‡ -->
    <div id="map"></div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ -->
    <div id="forecastModal" class="popup-overlay hidden">
        <div class="popup-content">
            <button onclick="closeModal()" class="close-btn">
                <i class="fas fa-times"></i>
            </button>
            <h3>Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ûµ Ø±ÙˆØ²Ù‡</h3>
            <table id="forecastTable">
                <thead style="background-color: rgb(156, 156, 255);">
                    <tr>
                        <th>ØªØ§Ø±ÛŒØ®</th>
                        <th>ÙˆØ¶Ø¹ÛŒØª</th>
                        <th>Ø¯Ù…Ø§ (Â°C)</th>
                        <th>Ø±Ø·ÙˆØ¨Øª (%)</th>
                        <th>Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯ (m/s)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <canvas id="tempChart"></canvas>
        </div>
    </div>

    <script>
        let lastClickedLat = null;
        let lastClickedLon = null;
        let currentMarker = null; 

        const map = L.map('map').setView([35.1054, 53.6405], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        map.zoomControl.setPosition('bottomleft');

        
        window.addEventListener("load", function () {
            const savedLat = localStorage.getItem("lat");
            const savedLon = localStorage.getItem("lon");

            if (savedLat && savedLon) {
                lastClickedLat = parseFloat(savedLat);
                lastClickedLon = parseFloat(savedLon);

                // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø§Ø±Ú©Ø± Ù…Ø¬Ø¯Ø¯
                currentMarker = L.marker([lastClickedLat, lastClickedLon])
                    .addTo(map)
                    .bindPopup(`
                        <div>
                            <p>Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: ${lastClickedLat.toFixed(4)}</p>
                            <p>Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: ${lastClickedLon.toFixed(4)}</p>
                            <button onclick="removeMarker()" style="margin-top:5px;background:#d9534f;color:white;border:none;padding:5px 10px;border-radius:5px;">ğŸ—‘ Ø­Ø°Ù</button>
                        </div>
                    `)
                    .openPopup();

                // Ø±ÙØªÙ† Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª
                map.setView([lastClickedLat, lastClickedLon], 8);

                // Ú¯Ø±ÙØªÙ† Ø¯Ø§Ø¯Ù‡ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ù…Ø¬Ø¯Ø¯
                fetch(`/weather/get_weather/?lat=${lastClickedLat}&lon=${lastClickedLon}`)
                    .then(res => res.json())
                    .then(data => {
                        if (!data.error) {
                            displayWeather(data);
                        }
                    });
            }
            if (window.location.pathname === "/logout/") {
                localStorage.removeItem("lat");
                localStorage.removeItem("lon");
            }
        });

        map.on('click', function(e) {
            lastClickedLat = e.latlng.lat;
            lastClickedLon = e.latlng.lng;

            localStorage.setItem("lat", lastClickedLat);
            localStorage.setItem("lon", lastClickedLon);

            // Ø­Ø°Ù Ù…Ø§Ø±Ú©Ø± Ù‚Ø¨Ù„ÛŒ
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø§Ø±Ú©Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ popup Ø´Ø§Ù…Ù„ lat Ùˆ lon
            currentMarker = L.marker([lastClickedLat, lastClickedLon])
                .addTo(map)
                .bindPopup(`
                    <div>
                        <p>Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: ${lastClickedLat.toFixed(4)}</p>
                        <p>Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: ${lastClickedLon.toFixed(4)}</p>
                        <button onclick="removeMarker()" style="margin-top:5px;background:#d9534f;color:white;border:none;padding:5px 10px;border-radius:5px;">ğŸ—‘ Ø­Ø°Ù</button>
                    </div>
                `)
                .openPopup();

            fetch(`/weather/get_weather/?lat=${lastClickedLat}&lon=${lastClickedLon}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) alert(data.error);
                    else {
                        displayWeather(data);
                        map.setView([lastClickedLat, lastClickedLon], 8);
                    }
                }).catch(() => alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§"));
        });

        function searchCity() {
            const city = document.getElementById("cityInput").value;
            if (!city) return alert("Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!");

            fetch(`/weather/search_city/?q=${city}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) alert(data.error);
                    else {
                        lastClickedLat = data.coord.lat;
                        lastClickedLon = data.coord.lon;

                        localStorage.setItem("lat", lastClickedLat);
                        localStorage.setItem("lon", lastClickedLon);

                        // Ø­Ø°Ù Ù…Ø§Ø±Ú©Ø± Ù‚Ø¨Ù„ÛŒ
                        if (currentMarker) {
                            map.removeLayer(currentMarker);
                        }

                        // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø§Ø±Ú©Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ popup Ø´Ø§Ù…Ù„ lat Ùˆ lon
                        currentMarker = L.marker([lastClickedLat, lastClickedLon])
                            .addTo(map)
                            .bindPopup(`
                                <div>
                                    <p>Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: ${lastClickedLat.toFixed(4)}</p>
                                    <p>Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ: ${lastClickedLon.toFixed(4)}</p>
                                    <button onclick="removeMarker()" style="margin-top:5px;background:#d9534f;color:white;border:none;padding:5px 10px;border-radius:5px;">ğŸ—‘ Ø­Ø°Ù</button>
                                </div>
                            `)
                            .openPopup();

                        map.setView([lastClickedLat, lastClickedLon], 8);
                        displayWeather(data);
                    }
                }).catch(() => alert("Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù‡Ø±"));
        }
            function displayWeather(data) {
                document.getElementById("weatherPanel").style.display = "block";
                document.getElementById("weatherInfo").innerHTML = `
                    <h3 class="weather-item-name">${data.name}</h3>
                    <div class="weather-row">
                        <div class="weather-item">
                            <img src="{% static 'images/cloudy.png' %}" alt="ÙˆØ¶Ø¹ÛŒØª">
                            <span>${data.weather[0].description}</span>
                        </div>
                        <div class="weather-item">
                            <img src="{% static 'images/high-temperature.png' %}" alt="Ø¯Ù…Ø§">
                            <span>${data.main.temp}Â°C</span>
                        </div>
                    </div>
                    <div class="weather-row">
                        <div class="weather-item">
                            <img src="{% static 'images/humidity.png' %}" alt="Ø±Ø·ÙˆØ¨Øª">
                            <span>${data.main.humidity}%</span>
                        </div>
                        <div class="weather-item">
                            <img src="{% static 'images/wind.png' %}" alt="Ø¨Ø§Ø¯">
                            <span>${data.wind.speed} m/s</span>
                        </div>
                    </div>
                `;
            }

        function getForecast() {
            if (!lastClickedLat || !lastClickedLon)
                return alert("Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù†Ù‚Ø·Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!");

            fetch(`/weather/get_forecast/?lat=${lastClickedLat}&lon=${lastClickedLon}`)
                .then(res => {
                    if (res.redirected) {
                        // Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ â†’ Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ø´Ø¯Ù‡ Ø¨Ù‡ login
                        window.location.href = res.url;
                        return;
                    }
                    return res.json();
                })
                .then(data => {
                    if (!data) return;  // Ø¯Ø± ØµÙˆØ±Øª Ø±ÛŒØ¯Ø§ÛŒØ±Ú©ØªØŒ Ø§Ø¯Ø§Ù…Ù‡ Ù†Ø¯Ù‡

                    if (data.error) alert(data.error);
                    else if (data.daily) showForecast(data.daily);
                    else alert("Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.");
                })
                .catch(() => alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ"));
        }

        function showForecast(daily) {
            const modal = document.getElementById("forecastModal");
            const tbody = document.querySelector("#forecastTable tbody");
            const labels = [], temps = [], wind = [];

            tbody.innerHTML = "";
            daily.forEach(day => {
                const date = new Date(day.dt_txt).toLocaleDateString('fa-IR');
                const weather = day.weather[0].description;
                const temp = day.main.temp;
                const humidity = day.main.humidity;
                const windspeed = day.wind.speed;

                labels.push(date);
                temps.push(temp);
                wind.push(windspeed);
                tbody.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${weather}</td>
                        <td>${temp}</td>
                        <td>${humidity}</td>
                        <td>${windspeed}</td>
                    </tr>`;
            });

            modal.classList.remove("hidden");
            renderChart(labels, temps, wind);
        }

        function closeModal() {
            document.getElementById("forecastModal").classList.add("hidden");
        }

        let chart = null;
        function renderChart(labels, temps, wind) {
            const ctx = document.getElementById("tempChart").getContext("2d");
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Ø¯Ù…Ø§ (Â°C)",
                        data: temps,
                        borderColor: "red",
                        backgroundColor: "rgba(255, 30, 30, 0.2)",
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: "Ø¨Ø§Ø¯ (m/s)",
                        data: wind,
                        borderColor: "blue",
                        backgroundColor: "#4240af7a",
                        tension: 0.4,
                        fill: true
                    }
                    
                ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw} Ø¯Ø±Ø¬Ù‡ Ø³Ø§Ù†ØªÛŒâ€ŒÚ¯Ø±Ø§Ø¯`
                            }
                        }
                    }
                }
            });
        }
        function removeMarker() {
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
                lastClickedLat = null;
                lastClickedLon = null;
                localStorage.removeItem("lat");
                localStorage.removeItem("lon");
                document.getElementById("weatherPanel").style.display = "none";
            }
        }
        
    </script>
</body>
</html>
